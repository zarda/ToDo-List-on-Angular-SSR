rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Functions ---
    // Checks if a user is authenticated.
    function isSignedIn() {
      return request.auth != null;
    }

    // Checks if the requesting user is the owner of a given list.
    function isListOwner(listId) {
      return get(/databases/$(database)/documents/lists/$(listId)).data.ownerUid == request.auth.uid;
    }

    // Checks if the requesting user is a member (owner or collaborator) of a given list.
    function isListMember(listId) {
      let list = get(/databases/$(database)/documents/lists/$(listId));
      return list.data.ownerUid == request.auth.uid || request.auth.uid in list.data.sharedWith;
    }

    // --- Collections ---
    match /users/{userId} {
      // Any authenticated user can read public profile data.
      allow read: if isSignedIn();

      // A user can only write to their own profile.
      allow write: if isSignedIn() && request.auth.uid == userId;
    }

    match /lists/{listId} {
      // A user can get a single list if they are a member.
      allow get: if isSignedIn() && isListMember(listId);

      // A user can query for lists they own or are shared with.
      // The client-side query must include a filter on 'ownerUid' or 'sharedWith'.
      allow list: if isSignedIn();

      // A user can create a list if they are signed in and are the designated owner.
      // We also validate the schema of the new list.
      allow create: if isSignedIn() 
                    && request.resource.data.ownerUid == request.auth.uid
                    && request.resource.data.name is string
                    && request.resource.data.sharedWith is map
                    && request.resource.data.sharedWith.size() == 0;

      // A list member can update the `sharedWith` field to add or remove collaborators.
      // Only the owner can change the list's name.
      allow update: if isSignedIn() && isListMember(listId);

      // Only the list owner can delete it.
      allow delete: if isSignedIn() && isListOwner(listId);

      // --- Subcollections ---
      match /todos/{todoId} {
        // For single doc reads, a user must be a member of the parent list.
        allow get: if isSignedIn() && isListMember(listId);
        
        // For collection queries, we allow any authenticated user to query.
        allow list: if isSignedIn();

        // A list member can create a todo.
        allow create: if isSignedIn()
                      && isListMember(listId);

        // A list member can update a todo.
        allow update: if isSignedIn()
                      && isListMember(listId);

        // A list member can delete a todo.
        allow delete: if isSignedIn()
                      && isListMember(listId);
      }
    }
  }
}